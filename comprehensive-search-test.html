<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bible Here 搜索功能完整測試</title>
    <link rel="stylesheet" href="public/css/bible-here-public.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007cba;
            padding-bottom: 10px;
        }
        .test-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007cba;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #005a87;
        }
        .performance-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007cba;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Bible Here 搜索功能完整測試</h1>
        <p>此頁面用於測試 Bible Here WordPress 插件的搜索功能各個組件。</p>

        <!-- 基本搜索測試 -->
        <div class="test-section">
            <h3>1. 基本搜索功能測試</h3>
            <div class="bible-search-form">
                <input type="text" id="basic-search-input" class="bible-search-input" placeholder="輸入搜索關鍵詞..." value="love">
                <button id="basic-search-btn" class="bible-search-button">搜索</button>
            </div>
            <div id="basic-search-results" class="bible-search-results"></div>
            <div id="basic-test-result" class="test-result"></div>
        </div>

        <!-- 高級搜索測試 -->
        <div class="test-section">
            <h3>2. 高級搜索功能測試</h3>
            <div class="bible-search-form">
                <input type="text" id="advanced-search-input" class="bible-search-input" placeholder="輸入搜索關鍵詞..." value="God">
                <div class="bible-search-filters">
                    <select id="version-filter" class="bible-filter-select">
                        <option value="">所有版本</option>
                        <option value="kjv" selected>KJV</option>
                        <option value="niv">NIV</option>
                    </select>
                    <select id="book-filter" class="bible-filter-select">
                        <option value="">所有書卷</option>
                        <option value="1">創世記</option>
                        <option value="19">詩篇</option>
                        <option value="40">馬太福音</option>
                    </select>
                    <select id="search-mode" class="bible-filter-select">
                        <option value="fulltext" selected>全文搜索</option>
                        <option value="exact">精確匹配</option>
                        <option value="regex">正則表達式</option>
                    </select>
                    <select id="sort-order" class="bible-filter-select">
                        <option value="relevance" selected>相關性</option>
                        <option value="book_order">書卷順序</option>
                    </select>
                </div>
                <button id="advanced-search-btn" class="bible-search-button">高級搜索</button>
            </div>
            <div id="advanced-search-results" class="bible-search-results"></div>
            <div id="advanced-test-result" class="test-result"></div>
        </div>

        <!-- 搜索建議測試 -->
        <div class="test-section">
            <h3>3. 搜索建議功能測試</h3>
            <div class="bible-search-form">
                <input type="text" id="suggestion-input" class="bible-search-input" placeholder="輸入部分關鍵詞測試建議..." value="lov">
                <button id="suggestion-test-btn">測試建議</button>
            </div>
            <div id="suggestion-results" class="bible-search-suggestions"></div>
            <div id="suggestion-test-result" class="test-result"></div>
        </div>

        <!-- 搜索歷史測試 -->
        <div class="test-section">
            <h3>4. 搜索歷史功能測試</h3>
            <div class="bible-search-form">
                <button id="load-history-btn">載入搜索歷史</button>
                <button id="clear-history-btn">清除歷史</button>
            </div>
            <div id="history-results" class="bible-search-history"></div>
            <div id="history-test-result" class="test-result"></div>
        </div>

        <!-- 性能測試 -->
        <div class="test-section">
            <h3>5. 搜索性能測試</h3>
            <div class="bible-search-form">
                <button id="performance-test-btn">執行性能測試</button>
                <button id="cache-test-btn">測試緩存機制</button>
            </div>
            <div class="performance-stats" id="performance-stats"></div>
            <div id="performance-test-result" class="test-result"></div>
        </div>

        <!-- 緩存統計 -->
        <div class="test-section">
            <h3>6. 緩存統計信息</h3>
            <div class="bible-search-form">
                <button id="cache-stats-btn">獲取緩存統計</button>
                <button id="clear-cache-btn">清除緩存</button>
            </div>
            <div class="performance-stats" id="cache-stats"></div>
            <div id="cache-test-result" class="test-result"></div>
        </div>
    </div>

    <!-- 添加jQuery庫 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- 模擬WordPress AJAX變量 -->
    <script>
        window.bible_here_ajax = {
            ajax_url: '/wp-admin/admin-ajax.php',
            nonce: 'test-nonce-12345'
        };
    </script>
    
    <script src="public/js/bible-here-public.js"></script>
    <script>
        // 測試結果記錄
        const testResults = {
            basic: false,
            advanced: false,
            suggestions: false,
            history: false,
            performance: false,
            cache: false
        };

        // 模擬 WordPress AJAX
        const ajaxUrl = '/wp-admin/admin-ajax.php';
        const nonce = 'test-nonce-12345';

        // 模擬 jQuery AJAX 請求
        function mockAjaxRequest(action, data, successCallback, errorCallback) {
            console.log(`模擬 AJAX 請求: ${action}`, data);
            
            // 模擬延遲
            setTimeout(() => {
                switch(action) {
                    case 'bible_here_search':
                        successCallback({
                            success: true,
                            data: {
                                results: [
                                    {
                                        id: 1,
                                        book_name: '約翰福音',
                                        chapter: 3,
                                        verse: 16,
                                        content: 'For God so loved the world...',
                                        version: 'KJV',
                                        relevance_score: 0.95
                                    },
                                    {
                                        id: 2,
                                        book_name: '哥林多前書',
                                        chapter: 13,
                                        verse: 4,
                                        content: 'Love is patient, love is kind...',
                                        version: 'KJV',
                                        relevance_score: 0.88
                                    }
                                ],
                                total: 25,
                                page: 1,
                                per_page: 10,
                                search_time: Math.random() * 100 + 50
                            }
                        });
                        break;
                    
                    case 'bible_here_search_suggestions':
                        successCallback({
                            success: true,
                            data: {
                                suggestions: ['love', 'loved', 'lovely', 'lover']
                            }
                        });
                        break;
                    
                    case 'bible_here_get_search_history':
                        successCallback({
                            success: true,
                            data: {
                                history: [
                                    { query: 'love', timestamp: Date.now() - 3600000 },
                                    { query: 'faith', timestamp: Date.now() - 7200000 },
                                    { query: 'hope', timestamp: Date.now() - 10800000 }
                                ]
                            }
                        });
                        break;
                    
                    case 'bible_here_clear_search_history':
                        successCallback({
                            success: true,
                            data: { message: '搜索歷史已清除' }
                        });
                        break;
                    
                    case 'bible_here_get_cache_stats':
                        successCallback({
                            success: true,
                            data: {
                                search_cache_count: 15,
                                suggestions_cache_count: 8,
                                total_cache_count: 23,
                                cache_size_bytes: 45678,
                                cache_size_mb: 0.044
                            }
                        });
                        break;
                    
                    case 'bible_here_clear_cache':
                        successCallback({
                            success: true,
                            data: { message: '緩存已清除' }
                        });
                        break;
                    
                    default:
                        errorCallback({ message: '未知的操作' });
                }
            }, Math.random() * 500 + 200);
        }

        // 重寫 jQuery AJAX
        if (typeof $ !== 'undefined' && $.ajax) {
            const originalAjax = $.ajax;
            $.ajax = function(options) {
                if (options.url && options.url.includes('admin-ajax.php')) {
                    const action = options.data.action;
                    mockAjaxRequest(action, options.data, options.success, options.error);
                } else {
                    return originalAjax.call(this, options);
                }
            };
        }

        // 測試函數
        function runBasicSearchTest() {
            const startTime = performance.now();
            const input = document.getElementById('basic-search-input');
            const results = document.getElementById('basic-search-results');
            const testResult = document.getElementById('basic-test-result');
            
            testResult.innerHTML = '<div class="info">執行基本搜索測試...</div>';
            
            // 觸發搜索
            if (typeof performAdvancedSearch === 'function') {
                performAdvancedSearch();
                const endTime = performance.now();
                testResults.basic = true;
                testResult.innerHTML = `<div class="success">✓ 基本搜索功能正常 (${(endTime - startTime).toFixed(2)}ms)</div>`;
            } else {
                testResult.innerHTML = '<div class="error">✗ performAdvancedSearch 函數未找到</div>';
            }
        }

        function runAdvancedSearchTest() {
            const startTime = performance.now();
            const testResult = document.getElementById('advanced-test-result');
            
            testResult.innerHTML = '<div class="info">執行高級搜索測試...</div>';
            
            // 檢查過濾器功能
            const filters = ['version-filter', 'book-filter', 'search-mode', 'sort-order'];
            let allFiltersFound = true;
            
            filters.forEach(filterId => {
                if (!document.getElementById(filterId)) {
                    allFiltersFound = false;
                }
            });
            
            if (allFiltersFound && typeof performAdvancedSearch === 'function') {
                performAdvancedSearch();
                const endTime = performance.now();
                testResults.advanced = true;
                testResult.innerHTML = `<div class="success">✓ 高級搜索功能正常 (${(endTime - startTime).toFixed(2)}ms)</div>`;
            } else {
                testResult.innerHTML = '<div class="error">✗ 高級搜索組件不完整</div>';
            }
        }

        function runSuggestionTest() {
            const startTime = performance.now();
            const testResult = document.getElementById('suggestion-test-result');
            
            testResult.innerHTML = '<div class="info">執行搜索建議測試...</div>';
            
            if (typeof loadSearchSuggestions === 'function') {
                loadSearchSuggestions('lov');
                const endTime = performance.now();
                testResults.suggestions = true;
                testResult.innerHTML = `<div class="success">✓ 搜索建議功能正常 (${(endTime - startTime).toFixed(2)}ms)</div>`;
            } else {
                testResult.innerHTML = '<div class="error">✗ loadSearchSuggestions 函數未找到</div>';
            }
        }

        function runHistoryTest() {
            const startTime = performance.now();
            const testResult = document.getElementById('history-test-result');
            
            testResult.innerHTML = '<div class="info">執行搜索歷史測試...</div>';
            
            if (typeof loadSearchHistory === 'function') {
                loadSearchHistory();
                const endTime = performance.now();
                testResults.history = true;
                testResult.innerHTML = `<div class="success">✓ 搜索歷史功能正常 (${(endTime - startTime).toFixed(2)}ms)</div>`;
            } else {
                testResult.innerHTML = '<div class="error">✗ loadSearchHistory 函數未找到</div>';
            }
        }

        function runPerformanceTest() {
            const testResult = document.getElementById('performance-test-result');
            const statsContainer = document.getElementById('performance-stats');
            
            testResult.innerHTML = '<div class="info">執行性能測試...</div>';
            
            const queries = ['love', 'God', 'faith', 'hope', 'peace'];
            const results = [];
            let completed = 0;
            
            queries.forEach((query, index) => {
                const startTime = performance.now();
                
                // 模擬搜索請求
                mockAjaxRequest('bible_here_search', { query }, 
                    (response) => {
                        const endTime = performance.now();
                        results.push({
                            query,
                            time: endTime - startTime,
                            results: response.data.results.length
                        });
                        
                        completed++;
                        if (completed === queries.length) {
                            displayPerformanceResults(results, statsContainer, testResult);
                        }
                    },
                    (error) => {
                        completed++;
                        if (completed === queries.length) {
                            displayPerformanceResults(results, statsContainer, testResult);
                        }
                    }
                );
            });
        }

        function displayPerformanceResults(results, container, testResult) {
            const avgTime = results.reduce((sum, r) => sum + r.time, 0) / results.length;
            const totalResults = results.reduce((sum, r) => sum + r.results, 0);
            
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${results.length}</div>
                    <div class="stat-label">測試查詢數</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgTime.toFixed(2)}ms</div>
                    <div class="stat-label">平均響應時間</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalResults}</div>
                    <div class="stat-label">總結果數</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${(totalResults / results.length).toFixed(1)}</div>
                    <div class="stat-label">平均結果數</div>
                </div>
            `;
            
            testResults.performance = true;
            testResult.innerHTML = '<div class="success">✓ 性能測試完成</div>';
        }

        function runCacheTest() {
            const testResult = document.getElementById('cache-test-result');
            
            testResult.innerHTML = '<div class="info">測試緩存機制...</div>';
            
            // 執行相同查詢兩次，測試緩存
            const query = 'test-cache-query';
            const startTime1 = performance.now();
            
            mockAjaxRequest('bible_here_search', { query }, 
                (response1) => {
                    const endTime1 = performance.now();
                    const time1 = endTime1 - startTime1;
                    
                    // 第二次查詢（應該使用緩存）
                    const startTime2 = performance.now();
                    mockAjaxRequest('bible_here_search', { query }, 
                        (response2) => {
                            const endTime2 = performance.now();
                            const time2 = endTime2 - startTime2;
                            
                            testResults.cache = true;
                            testResult.innerHTML = `
                                <div class="success">✓ 緩存測試完成</div>
                                <div class="info">首次查詢: ${time1.toFixed(2)}ms</div>
                                <div class="info">緩存查詢: ${time2.toFixed(2)}ms</div>
                                <div class="info">性能提升: ${((time1 - time2) / time1 * 100).toFixed(1)}%</div>
                            `;
                        },
                        (error) => {
                            testResult.innerHTML = '<div class="error">✗ 緩存測試失敗</div>';
                        }
                    );
                },
                (error) => {
                    testResult.innerHTML = '<div class="error">✗ 緩存測試失敗</div>';
                }
            );
        }

        function getCacheStats() {
            const testResult = document.getElementById('cache-test-result');
            const statsContainer = document.getElementById('cache-stats');
            
            testResult.innerHTML = '<div class="info">獲取緩存統計...</div>';
            
            mockAjaxRequest('bible_here_get_cache_stats', {}, 
                (response) => {
                    const stats = response.data;
                    statsContainer.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-value">${stats.search_cache_count}</div>
                            <div class="stat-label">搜索緩存條目</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.suggestions_cache_count}</div>
                            <div class="stat-label">建議緩存條目</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.total_cache_count}</div>
                            <div class="stat-label">總緩存條目</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.cache_size_mb.toFixed(3)}MB</div>
                            <div class="stat-label">緩存大小</div>
                        </div>
                    `;
                    testResult.innerHTML = '<div class="success">✓ 緩存統計獲取成功</div>';
                },
                (error) => {
                    testResult.innerHTML = '<div class="error">✗ 獲取緩存統計失敗</div>';
                }
            );
        }

        function clearCache() {
            const testResult = document.getElementById('cache-test-result');
            
            testResult.innerHTML = '<div class="info">清除緩存...</div>';
            
            mockAjaxRequest('bible_here_clear_cache', {}, 
                (response) => {
                    testResult.innerHTML = '<div class="success">✓ 緩存已清除</div>';
                    // 重新獲取統計
                    setTimeout(getCacheStats, 500);
                },
                (error) => {
                    testResult.innerHTML = '<div class="error">✗ 清除緩存失敗</div>';
                }
            );
        }

        function clearHistory() {
            const testResult = document.getElementById('history-test-result');
            
            testResult.innerHTML = '<div class="info">清除搜索歷史...</div>';
            
            if (typeof clearSearchHistory === 'function') {
                clearSearchHistory();
                testResult.innerHTML = '<div class="success">✓ 搜索歷史已清除</div>';
            } else {
                testResult.innerHTML = '<div class="error">✗ clearSearchHistory 函數未找到</div>';
            }
        }

        // 事件綁定
        document.addEventListener('DOMContentLoaded', function() {
            // 基本搜索測試
            document.getElementById('basic-search-btn').addEventListener('click', runBasicSearchTest);
            
            // 高級搜索測試
            document.getElementById('advanced-search-btn').addEventListener('click', runAdvancedSearchTest);
            
            // 搜索建議測試
            document.getElementById('suggestion-test-btn').addEventListener('click', runSuggestionTest);
            
            // 搜索歷史測試
            document.getElementById('load-history-btn').addEventListener('click', runHistoryTest);
            document.getElementById('clear-history-btn').addEventListener('click', clearHistory);
            
            // 性能測試
            document.getElementById('performance-test-btn').addEventListener('click', runPerformanceTest);
            document.getElementById('cache-test-btn').addEventListener('click', runCacheTest);
            
            // 緩存統計
            document.getElementById('cache-stats-btn').addEventListener('click', getCacheStats);
            document.getElementById('clear-cache-btn').addEventListener('click', clearCache);
            
            console.log('Bible Here 搜索功能測試頁面已載入');
        });
    </script>
</body>
</html>